!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("websocket")):"function"==typeof define&&define.amd?define(["websocket"],t):"object"==typeof exports?exports.BCI2K=t(require("websocket")):e.BCI2K=t(e.websocket)}(this,(function(e){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="C:\\Users\\fortu\\Projects\\Hopkins\\BCI2000\\BCI2K\\BCI2K.js\\dist",s(s.s=0)}([function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};const n=s(1).w3cwebsocket;class r{constructor(e){this._socket=null,this.onconnect=()=>{},this.onGenericSignal=e=>{},this.onStateVector=e=>{},this.onSignalProperties=e=>{},this.onStateFormat=e=>{},this.ondisconnect=()=>{},this.onReceiveBlock=()=>{},this.callingFrom="",this.states={},this.signal=null,this.signalProperties=null,this.stateFormat=null,this.stateVecOrder=null,this.SignalType={INT16:0,FLOAT24:1,FLOAT32:2,INT32:3},this.address=e}getNullTermString(e){var t="";let s=0;for(;s<e.byteLength;){var i=e.getUint8(s);if(s++,0==i)break;t+=String.fromCharCode(i)}return t}connect(e,t){let s=this;return void 0===s.address&&(s.address=e),this.callingFrom=t,new Promise((e,t)=>{s._socket=new n(s.address),s._socket.binaryType="arraybuffer",s._socket.onerror=()=>{console.log("BLAH"),t("Error connecting to data source at "+s.address)},s._socket.onopen=()=>{s.onconnect(),e()},s._socket.onclose=e=>{s.ondisconnect(),setTimeout(()=>{console.log("Disconnected"),this.connect("")},1e3)},s._socket.onmessage=e=>{s._decodeMessage(e.data)}})}connected(){return null!=this._socket&&this._socket.readyState===n.OPEN}_decodeMessage(e){let t=new DataView(e,0,1).getUint8(0);switch(t){case 3:let s=new DataView(e,1,e.byteLength-1);this._decodeStateFormat(s);break;case 4:let i=new DataView(e,1,2).getUint8(0);switch(i){case 1:let t=new DataView(e,2,e.byteLength-2);this._decodeGenericSignal(t);break;case 3:let s=new DataView(e,2,e.byteLength-2);this._decodeSignalProperties(s);break;default:console.error("Unsupported Supplement: "+i.toString())}this.onReceiveBlock();break;case 5:let n=new DataView(e,1,e.byteLength-1);this._decodeStateVector(n);break;default:console.error("Unsupported Descriptor: "+t.toString())}}_decodePhysicalUnits(e){let t;t={};let s=e.split(" "),i=0;return t.offset=Number(s[i++]),t.gain=Number(s[i++]),t.symbol=s[i++],t.vmin=Number(s[i++]),t.vmax=Number(s[i++]),t}_decodeSignalProperties(e){let t=this.getNullTermString(e);t=(t=t.replace(/{/g," { ")).replace(/}/g," } "),this.signalProperties={};let s=t.split(" "),i=[];for(let e=0;e<s.length;e++)""!==s[e].trim()&&i.push(s[e]);let n=0;if(this.signalProperties.name=i[n++],this.signalProperties.channels=[],"{"===i[n]){for(;"}"!==i[++n];)this.signalProperties.channels.push(i[n]);n++}else{let e=parseInt(i[n++]);for(let t=0;t<e;t++)this.signalProperties.channels.push((t+1).toString())}if(this.signalProperties.elements=[],"{"===i[n]){for(;"}"!==i[++n];)this.signalProperties.elements.push(i[n]);n++}else{let e=parseInt(i[n++]);for(let t=0;t<e;t++)this.signalProperties.elements.push((t+1).toString())}this.signalProperties.numelements=this.signalProperties.elements.length,this.signalProperties.signaltype=i[n++],this.signalProperties.channelunit=this._decodePhysicalUnits(i.slice(n,n+=5).join(" ")),this.signalProperties.elementunit=this._decodePhysicalUnits(i.slice(n,n+=5).join(" ")),n++,this.signalProperties.valueunits=[];for(let e=0;e<this.signalProperties.channels.length;e++)this.signalProperties.valueunits.push(this._decodePhysicalUnits(i.slice(n,n+=5).join(" ")));n++,this.onSignalProperties(this.signalProperties)}_decodeStateFormat(e){this.stateFormat={};let t=this.getNullTermString(e).split("\n");for(let e=0;e<t.length;e++){if(0===t[e].trim().length)continue;let s=t[e].split(" "),i=s[0];this.stateFormat[i]={},this.stateFormat[i].bitWidth=parseInt(s[1]),this.stateFormat[i].defaultValue=parseInt(s[2]),this.stateFormat[i].byteLocation=parseInt(s[3]),this.stateFormat[i].bitLocation=parseInt(s[4])}let s=[];for(let e in this.stateFormat){let t=8*this.stateFormat[e].byteLocation;t+=this.stateFormat[e].bitLocation,s.push([e,t])}s.sort((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0),this.stateVecOrder=[];for(let e=0;e<s.length;e++){let t=s[e][0];this.stateVecOrder.push([t,this.stateFormat[t].bitWidth])}this.onStateFormat(this.stateFormat)}_decodeGenericSignal(e){let t=0,s=e.getUint8(t);t+=1;let i=e.getUint16(t,!0);t+=s;let n=e.getUint16(t,!0);t=e.byteOffset+t+s;let r=new DataView(e.buffer,t),o=[];for(let e=0;e<i;++e){o.push([]);for(let t=0;t<n;++t)switch(s){case this.SignalType.INT16:o[e].push(r.getInt16(2*(n*e+t),!0));break;case this.SignalType.FLOAT32:o[e].push(r.getFloat32(4*(n*e+t),!0));break;case this.SignalType.INT32:o[e].push(r.getInt32(4*(n*e+t),!0));break;case this.SignalType.FLOAT24:o[e].push(0)}}this.signal=o,this.onGenericSignal(o)}_decodeStateVector(e){if(null==this.stateVecOrder)return;let t=1,s=new DataView(e.buffer,t,2);t+=3;let i=parseInt(this.getNullTermString(s)),n=new DataView(e.buffer,t,2);t+=3;let r=parseInt(this.getNullTermString(n)),o=new DataView(e.buffer,t),a={};for(let e in this.stateFormat)a[e]=Array(r).fill(this.stateFormat[e].defaultValue);for(let e=0;e<r;e++){let t=new Uint8Array(o.buffer,o.byteOffset+e*i,i),s=[];for(let e=0;e<t.length;e++)s.push(0!=(1&t[e])?1:0),s.push(0!=(2&t[e])?1:0),s.push(0!=(4&t[e])?1:0),s.push(0!=(8&t[e])?1:0),s.push(0!=(16&t[e])?1:0),s.push(0!=(32&t[e])?1:0),s.push(0!=(64&t[e])?1:0),s.push(0!=(128&t[e])?1:0);for(let t=0;t<this.stateVecOrder.length;t++){let i=this.stateFormat[this.stateVecOrder[t][0]],n=8*i.byteLocation+i.bitLocation,r=0,o=1;for(let e=0;e<i.bitWidth;e++)s[n+e]&&(r=(r|o)>>>0),o=o<<1>>>0;a[this.stateVecOrder[t][0]][e]=r}}this.onStateVector(a),this.states=a}}e.exports={bciOperator:class{constructor(e){this.ondisconnect=()=>{},this.onStateChange=e=>{},this._execid=0,this._exec={},this.state="",this.address=e}connect(e){return new Promise((t,s)=>{void 0===this.address&&(this.address=e||"ws://127.0.0.1:80"),this.websocket=new n(this.address),this.websocket.onerror=e=>{s("Error connecting to BCI2000 at "+this.address)},this.websocket.onopen=()=>{t()},this.websocket.onclose=()=>{this.ondisconnect()},this.websocket.onmessage=e=>{console.log(this._exec);let{opcode:t,id:s,contents:i}=JSON.parse(e.data);switch(t){case"O":this._exec[s](i),delete this._exec[s]}}})}tap(e){let t=this,s="WS"+e+"Server";return this.execute("Get Parameter "+s).then(e=>{if(e.indexOf("does not exist")>=0)return Promise.reject("Location parameter does not exist");if(""===e)return Promise.reject("Location parameter not set");let s=new r;return s.connect(t.address+":"+e.split(":")[1],"").then(e=>s)})}connected(){return null!==this.websocket&&this.websocket.readyState===n.OPEN}execute(e){let t=this;return this.connected()?new Promise((s,i)=>{let n=(++t._execid).toString();t._exec[n]=e=>s(e),t.websocket.send(JSON.stringify({opcode:"E",id:n,contents:e}))}):Promise.reject("Cannot execute instruction: not connected to BCI2000")}getVersion(){this.execute("Version").then(e=>console.log(e.split(" ")[1]))}showWindow(){return this.execute("Show Window")}hideWindow(){return this.execute("Hide Window")}setWatch(e,t,s){return this.execute("Add watch "+e+" at "+t+":"+s)}resetSystem(){return this.execute("Reset System")}setConfig(){return this.execute("Set Config")}start(){return this.execute("Start")}stop(){return this.execute("Stop")}kill(){return this.execute("Exit")}stateListen(){setInterval(()=>{this.execute("GET SYSTEM STATE").then(e=>{e.trim()!=this.state&&(this.onStateChange(e.trim()),this.state=e.trim())})},500)}getSubjectName(){return i(this,void 0,void 0,(function*(){return yield this.execute("Get Parameter SubjectName")}))}getTaskName(){return i(this,void 0,void 0,(function*(){return yield this.execute("Get Parameter DataFile")}))}},bciData:r}},function(t,s){t.exports=e}])}));
//# sourceMappingURL=index.js.map